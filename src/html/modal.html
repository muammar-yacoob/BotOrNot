<div class="modal-content">
  <div class="modal-header">
    <h3>🔎 Bot or Not? Analysis</h3>
    <button class="btn-close" id="close-btn">&times;</button>
  </div>
  
  <div class="modal-body">
    <!-- Main Result Card -->
    <div class="card card-result" id="result-card">
      <div class="text-primary" id="result-text"></div>
      <div class="text-secondary" id="tool-text" style="display: none;">🛠️ <span id="tool-name"></span></div>
      <div class="text-dim">Method: <span id="method-text"></span></div>
    </div>

    <!-- Signatures Section -->
    <div class="section">
      <div class="section-header">🔍 Found Signatures (<span id="signature-count">0</span>)</div>
      <div class="section-content">
        <div class="list" id="signatures-list"></div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="section">
      <div class="section-header">📊 Analysis Summary</div>
      <div class="section-content">
        <div class="metrics" id="summary-metrics"></div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="section">
      <div class="section-header">🎨 Filter Analysis</div>
      <div class="section-content">
        <div class="list" id="filters-list"></div>
      </div>
    </div>
    
    <!-- Image Preview -->
    <div class="image-preview">
      <img id="analyzed-image" alt="Analyzed media">
    </div>
    
    <!-- Technical Details -->
    <details id="details-details">
      <summary>📋 Technical Details</summary>
      <div class="content scrollable" id="details-content">
        <ul id="details-list"></ul>
      </div>
    </details>
  </div>
  
  <div class="modal-footer">
    <button class="btn" id="copy-btn">Copy & Close</button>
  </div>
</div>

<script>
// Forward control - modal.html fetches data from offline database
async function initializeModal() {
    // Get the source URL from the modal data attribute
    const modal = document.querySelector('[data-bot-or-not-modal]');
    const srcUrl = modal?.dataset.srcUrl;

    if (!srcUrl) {
        console.error('No source URL found for modal');
        document.getElementById('result-text').textContent = '❌ No source URL';
        return;
    }

    // Show loading state
    document.getElementById('result-text').textContent = '🔄 Loading analysis...';

    try {
        // Fetch analysis data from offline database
        const analysisData = await getStoredAnalysis(srcUrl);

        if (!analysisData) {
            console.warn('❌ No analysis data found in storage for image:', srcUrl);
            document.getElementById('result-text').textContent = '❌ No analysis data found';
            return;
        }


        // Populate modal with analysis data
        populateModalData(analysisData, srcUrl);

    } catch (error) {
        console.error('Modal initialization failed:', error);
        document.getElementById('result-text').textContent = '❌ Analysis Failed: ' + error.message;
    }
}

// Get storage key using same pattern as content.js
function getStorageKey(srcUrl) {
    const pageUrl = window.location.href.split('#')[0]; // Remove hash
    return `bot-or-not-analysis-${pageUrl}-${srcUrl}`;
}

// Fetch stored analysis from chrome.storage.local
async function getStoredAnalysis(srcUrl) {
    const key = getStorageKey(srcUrl);
    const result = await chrome.storage.local.get(key);
    return result[key]?.analysis || null;
}

// Populate modal sections with analysis data
function populateModalData(analysis, srcUrl) {
    // 1. Main Result Card
    const resultText = document.getElementById('result-text');
    resultText.textContent = analysis.result === 'error' ? '❌ Error' :
                            analysis.result === 'AI' ? '🤖 AI Generated' :
                            analysis.result === 'CGI' ? '🎨 CGI/Digital Art' :
                            '🌱 Organic Content';
    resultText.className = analysis.result === 'error' ? 'text-error' :
                          analysis.result === 'AI' || analysis.result === 'CGI' ? 'text-danger' :
                          'text-success';

    // 2. Signatures Section
    const signatureCount = document.getElementById('signature-count');
    const signaturesList = document.getElementById('signatures-list');
    const signatures = analysis.signatures || [];
    signatureCount.textContent = signatures.length;

    if (signatures.length > 0) {
        signaturesList.innerHTML = signatures.map(sig =>
            `<div class="list-item">
                <div class="list-item-title">${sig.signature || 'Unknown'}</div>
                <div class="list-item-subtitle">${sig.tool || 'Unknown Tool'}</div>
            </div>`
        ).join('');
    } else {
        signaturesList.innerHTML = '<div class="list-item"><div class="list-item-title">No AI signatures detected</div></div>';
    }

    // 3. Summary Section - Only show color count and gradient ratio
    const summaryMetrics = document.getElementById('summary-metrics');
    const metricsHtml = [];
    
    if (typeof analysis.colors === 'number') {
        metricsHtml.push(`<div class="metric"><span class="metric-label">Unique Colors:</span> <span class="metric-value">${analysis.colors}</span></div>`);
    }
    if (typeof analysis.gradientRatio === 'number') {
        metricsHtml.push(`<div class="metric"><span class="metric-label">Gradient Ratio:</span> <span class="metric-value">${analysis.gradientRatio.toFixed(2)}</span></div>`);
    }
    summaryMetrics.innerHTML = metricsHtml.join('');

    // 4. Image Preview
    const analyzedImage = document.getElementById('analyzed-image');
    analyzedImage.src = srcUrl;
    analyzedImage.onerror = () => {
        analyzedImage.style.display = 'none';
    };

    // 5. Technical Details
    const detailsList = document.getElementById('details-list');
    let detailsHtml = `<li>Source URL: ${srcUrl}</li>`;
    detailsHtml += `<li>Result: ${analysis.result}</li>`;
    if (typeof analysis.colors === 'number') {
        detailsHtml += `<li>Unique Colors: ${analysis.colors}</li>`;
    }
    if (typeof analysis.gradientRatio === 'number') {
        detailsHtml += `<li>Gradient Ratio: ${analysis.gradientRatio.toFixed(2)}</li>`;
    }
    detailsList.innerHTML = detailsHtml;

    // 7. Setup Copy Button
    const copyBtn = document.getElementById('copy-btn');
    copyBtn.onclick = () => {
        const summaryText = createSummaryText(analysis, srcUrl);
        navigator.clipboard.writeText(summaryText).then(() => {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy & Close';
            }, 1000);
        });
    };

    // 8. Setup Close Button
    const closeBtn = document.getElementById('close-btn');
    closeBtn.onclick = () => {
        if (window.BotOrNotContent?.closeModal) {
            window.BotOrNotContent.closeModal();
        }
    };
}

// Create summary text for copying
function createSummaryText(analysis, srcUrl) {
    let summary = `Bot or Not Analysis\n`;
    summary += `==================\n`;
    summary += `Image: ${srcUrl}\n`;
    summary += `Result: ${analysis.result}\n`;

    if (analysis.signatures?.length > 0) {
        summary += `\nSignatures Found:\n`;
        analysis.signatures.forEach(sig => {
            summary += `- ${sig.signature} (${sig.tool})\n`;
        });
    }

    if (typeof analysis.colors === 'number') {
        summary += `Unique Colors: ${analysis.colors}\n`;
    }
    if (typeof analysis.gradientRatio === 'number') {
        summary += `Gradient Ratio: ${analysis.gradientRatio.toFixed(2)}\n`;
    }

    return summary;
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeModal);
} else {
    initializeModal();
}
</script>