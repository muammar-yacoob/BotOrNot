<div class="modal-content">
  <div class="modal-header">
    <h3>üîé Bot or Not? Analysis</h3>
    <button class="btn-close" id="close-btn">&times;</button>
  </div>
  
  <div class="modal-body">
    <!-- Main Result Card -->
    <div class="card card-result" id="result-card">
      <div class="text-primary" id="result-text"></div>
      <div class="text-secondary" id="tool-text" style="display: none;">üõ†Ô∏è <span id="tool-name"></span></div>
      <div class="text-dim">Method: <span id="method-text"></span></div>
    </div>

    <!-- Signatures Section -->
    <div class="section">
      <div class="section-header">üîç Found Signatures (<span id="signature-count">0</span>)</div>
      <div class="section-content">
        <div class="list" id="signatures-list"></div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="section">
      <div class="section-header">üìä Analysis Summary</div>
      <div class="section-content">
        <div class="metrics" id="summary-metrics"></div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="section">
      <div class="section-header">üé® Filter Analysis</div>
      <div class="section-content">
        <div class="list" id="filters-list"></div>
      </div>
    </div>
    
    <!-- Image Preview -->
    <div class="image-preview">
      <img id="analyzed-image" alt="Analyzed media">
    </div>
    
    <!-- Technical Details -->
    <details id="details-details">
      <summary>üìã Technical Details</summary>
      <div class="content scrollable" id="details-content">
        <ul id="details-list"></ul>
      </div>
    </details>
  </div>
  
  <div class="modal-footer">
    <button class="btn" id="copy-btn">Copy & Close</button>
  </div>
</div>

<script>
// Forward control - modal.html fetches data from offline database
async function initializeModal() {
    // Get the source URL from the modal data attribute
    const modal = document.querySelector('[data-bot-or-not-modal]');
    const srcUrl = modal?.dataset.srcUrl;

    if (!srcUrl) {
        console.error('No source URL found for modal');
        document.getElementById('result-text').textContent = '‚ùå No source URL';
        return;
    }

    // Show loading state
    document.getElementById('result-text').textContent = 'üîÑ Loading analysis...';

    try {
        // Fetch analysis data from offline database
        const analysisData = await getStoredAnalysis(srcUrl);

        if (!analysisData) {
            console.warn('‚ùå No analysis data found in storage for image:', srcUrl);
            document.getElementById('result-text').textContent = '‚ùå No analysis data found';
            return;
        }


        // Populate modal with analysis data
        populateModalData(analysisData, srcUrl);

    } catch (error) {
        console.error('Modal initialization failed:', error);
        document.getElementById('result-text').textContent = '‚ùå Analysis Failed: ' + error.message;
    }
}

// Get storage key using same pattern as content.js
function getStorageKey(srcUrl) {
    const pageUrl = window.location.href.split('#')[0]; // Remove hash
    return `bot-or-not-analysis-${pageUrl}-${srcUrl}`;
}

// Fetch stored analysis from chrome.storage.local
async function getStoredAnalysis(srcUrl) {
    const key = getStorageKey(srcUrl);
    const result = await chrome.storage.local.get(key);
    return result[key]?.analysis || null;
}

// Populate modal sections with analysis data
function populateModalData(analysis, srcUrl) {

    // 1. Main Result Card
    const resultText = document.getElementById('result-text');
    const toolText = document.getElementById('tool-text');
    const toolName = document.getElementById('tool-name');
    const methodText = document.getElementById('method-text');

    if (analysis.confidence === 'error') {
        resultText.textContent = '‚ùå Analysis Error';
        resultText.className = 'text-error';
        methodText.textContent = 'Error occurred during analysis';
        if (analysis.error) {
            document.getElementById('details-content').innerHTML = `<ul><li>Error: ${analysis.error}</li></ul>`;
        }
    } else if (analysis.isAI) {
        resultText.textContent = `ü§ñ AI Generated (${analysis.confidence} confidence)`;
        resultText.className = 'text-danger';
        if (analysis.detectedTool) {
            toolText.style.display = 'block';
            toolName.textContent = analysis.detectedTool;
        }
    } else {
        resultText.textContent = 'üå± Organic Content';
        resultText.className = 'text-success';
    }

    methodText.textContent = analysis.method || 'Unknown';

    // 2. Signatures Section
    const signatureCount = document.getElementById('signature-count');
    const signaturesList = document.getElementById('signatures-list');

    const signatures = analysis.signatures || [];
    signatureCount.textContent = signatures.length;

    if (signatures.length > 0) {
        signaturesList.innerHTML = signatures.map(sig =>
            `<div class="list-item">
                <div class="list-item-title">${sig.signature || 'Unknown'}</div>
                <div class="list-item-subtitle">${sig.tool || 'Unknown Tool'}</div>
            </div>`
        ).join('');
    } else {
        signaturesList.innerHTML = '<div class="list-item"><div class="list-item-title">No AI signatures detected</div></div>';
    }

    // 3. Summary Section
    const summaryMetrics = document.getElementById('summary-metrics');
    const metricsHtml = [
        `<div class="metric"><span class="metric-label">Confidence:</span> <span class="metric-value">${analysis.confidence || 'none'}</span></div>`,
        `<div class="metric"><span class="metric-label">AI Score:</span> <span class="metric-value">${analysis.aiScore || 0}/${analysis.maxScore || 100}</span></div>`,
        `<div class="metric"><span class="metric-label">Detection Method:</span> <span class="metric-value">${analysis.method || 'unknown'}</span></div>`
    ];

    if (analysis.cgiDetection && !analysis.cgiDetection.corsBlocked) {
        metricsHtml.push(`<div class="metric"><span class="metric-label">Unique Colors:</span> <span class="metric-value">${analysis.cgiDetection.metrics?.uniqueColors || 0}</span></div>`);
        metricsHtml.push(`<div class="metric"><span class="metric-label">Gradient Ratio:</span> <span class="metric-value">${(analysis.cgiDetection.metrics?.gradientRatio || 0).toFixed(2)}</span></div>`);
    }

    summaryMetrics.innerHTML = metricsHtml.join('');

    // 4. Filters Section
    const filtersList = document.getElementById('filters-list');
    const filters = analysis.cgiDetection?.filtersDetected || [];

    if (filters.length > 0) {
        filtersList.innerHTML = filters.map(filter =>
            `<div class="list-item"><div class="list-item-title">${filter}</div></div>`
        ).join('');
    } else {
        filtersList.innerHTML = '<div class="list-item"><div class="list-item-title">No photo filters detected</div></div>';
    }

    // 5. Image Preview
    const analyzedImage = document.getElementById('analyzed-image');
    analyzedImage.src = srcUrl;
    analyzedImage.onerror = () => {
        analyzedImage.style.display = 'none';
    };

    // 6. Technical Details
    const detailsList = document.getElementById('details-list');
    const details = analysis.details || [];

    const detailsHtml = details.map(detail => `<li>${detail}</li>`).join('');

    // Add file info
    let fileInfo = `<li>Source URL: ${srcUrl}</li>`;
    if (analysis.fileInfo?.type) {
        fileInfo += `<li>Media Type: ${analysis.fileInfo.type}</li>`;
    }

    detailsList.innerHTML = fileInfo + detailsHtml;

    // 7. Setup Copy Button
    const copyBtn = document.getElementById('copy-btn');
    copyBtn.onclick = () => {
        const summaryText = createSummaryText(analysis, srcUrl);
        navigator.clipboard.writeText(summaryText).then(() => {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy & Close';
            }, 1000);
        });
    };

    // 8. Setup Close Button
    const closeBtn = document.getElementById('close-btn');
    closeBtn.onclick = () => {
        if (window.BotOrNotContent?.closeModal) {
            window.BotOrNotContent.closeModal();
        }
    };
}

// Create summary text for copying
function createSummaryText(analysis, srcUrl) {
    let summary = `Bot or Not Analysis\n`;
    summary += `==================\n`;
    summary += `Image: ${srcUrl}\n`;
    summary += `Result: ${analysis.isAI ? 'AI Generated' : 'Organic Content'}\n`;
    summary += `Confidence: ${analysis.confidence}\n`;
    summary += `Method: ${analysis.method}\n`;

    if (analysis.detectedTool) {
        summary += `Tool: ${analysis.detectedTool}\n`;
    }

    if (analysis.signatures?.length > 0) {
        summary += `\nSignatures Found:\n`;
        analysis.signatures.forEach(sig => {
            summary += `- ${sig.signature} (${sig.tool})\n`;
        });
    }

    if (analysis.details?.length > 0) {
        summary += `\nDetails:\n`;
        analysis.details.forEach(detail => {
            summary += `- ${detail}\n`;
        });
    }

    return summary;
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeModal);
} else {
    initializeModal();
}
</script>